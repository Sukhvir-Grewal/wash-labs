{
    "sourceFile": "pages/api/booking.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1757955580780,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757957896503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,67 @@\n+import nodemailer from \"nodemailer\";\r\n+\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n+\r\n+    try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: process.env.EMAIL_USER,\r\n+                pass: process.env.EMAIL_PASS,\r\n+            },\r\n+        });\r\n+\r\n+        // Compose the booking email\r\n+        const mailOptions = {\r\n+            from: `\"WashLabs Booking\" <no-reply@washlabs.ca>`,\r\n+            to: \"washlabs.ca@gmail.com\",\r\n+            subject: `‚úÖ New Booking Request - ${service.title}`,\r\n+            html: `\r\n+        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n+        \r\n+        <h3 style=\"color:#f97316;\">Service</h3>\r\n+        <p><strong>${service.title}</strong></p>\r\n+        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n+        <p>${vehicle.year} ${vehicle.name}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n+        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n+        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n+        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n+        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${\r\n+                userInfo.phone\r\n+            }</p>\r\n+        ${\r\n+            userInfo.message\r\n+                ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n+                : \"\"\r\n+        }\r\n+\r\n+        <hr />\r\n+        <p style=\"font-size:0.9rem;color:gray;\">\r\n+          This booking was submitted from the WashLabs website booking form.\r\n+        </p>\r\n+      `,\r\n+        };\r\n+\r\n+        await transporter.sendMail(mailOptions);\r\n+\r\n+        return res.status(200).json({ message: \"Booking sent successfully\" });\r\n+    } catch (error) {\r\n+        console.error(\"Error sending booking email:\", error);\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1757957913572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,9 +21,9 @@\n         });\r\n \r\n         // Compose the booking email\r\n         const mailOptions = {\r\n-            from: `\"WashLabs Booking\" <no-reply@washlabs.ca>`,\r\n+            from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n             to: \"washlabs.ca@gmail.com\",\r\n             subject: `‚úÖ New Booking Request - ${service.title}`,\r\n             html: `\r\n         <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n"
                },
                {
                    "date": 1758176244649,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,32 +1,32 @@\n import nodemailer from \"nodemailer\";\r\n \r\n export default async function handler(req, res) {\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ message: \"Method not allowed\" });\r\n-    }\r\n+  if (req.method !== \"POST\") {\r\n+    return res.status(405).json({ message: \"Method not allowed\" });\r\n+  }\r\n \r\n-    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+  const { service, vehicle, dateTime, userInfo } = req.body;\r\n \r\n-    if (!service || !vehicle || !dateTime || !userInfo) {\r\n-        return res.status(400).json({ message: \"Missing booking details\" });\r\n-    }\r\n+  if (!service || !vehicle || !dateTime || !userInfo) {\r\n+    return res.status(400).json({ message: \"Missing booking details\" });\r\n+  }\r\n \r\n-    try {\r\n-        const transporter = nodemailer.createTransport({\r\n-            service: \"gmail\",\r\n-            auth: {\r\n-                user: process.env.EMAIL_USER,\r\n-                pass: process.env.EMAIL_PASS,\r\n-            },\r\n-        });\r\n+  try {\r\n+    const transporter = nodemailer.createTransport({\r\n+      service: \"gmail\",\r\n+      auth: {\r\n+        user: process.env.EMAIL_USER,\r\n+        pass: process.env.EMAIL_PASS,\r\n+      },\r\n+    });\r\n \r\n-        // Compose the booking email\r\n-        const mailOptions = {\r\n-            from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n-            to: \"washlabs.ca@gmail.com\",\r\n-            subject: `‚úÖ New Booking Request - ${service.title}`,\r\n-            html: `\r\n+    // üì© Admin notification email\r\n+    const mailOptions = {\r\n+      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n+      to: \"washlabs.ca@gmail.com\",\r\n+      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n+      html: `\r\n         <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n         \r\n         <h3 style=\"color:#f97316;\">Service</h3>\r\n         <p><strong>${service.title}</strong></p>\r\n@@ -41,27 +41,66 @@\n         <h3 style=\"color:#f97316;\">Client Information</h3>\r\n         <p><strong>Name:</strong> ${userInfo.name}</p>\r\n         <p><strong>Email:</strong> ${userInfo.email}</p>\r\n         <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${\r\n-                userInfo.phone\r\n-            }</p>\r\n+        userInfo.phone\r\n+      }</p>\r\n         ${\r\n-            userInfo.message\r\n-                ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n-                : \"\"\r\n+          userInfo.message\r\n+            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n+            : \"\"\r\n         }\r\n \r\n         <hr />\r\n         <p style=\"font-size:0.9rem;color:gray;\">\r\n           This booking was submitted from the WashLabs website booking form.\r\n         </p>\r\n       `,\r\n-        };\r\n+    };\r\n \r\n-        await transporter.sendMail(mailOptions);\r\n+    await transporter.sendMail(mailOptions);\r\n \r\n-        return res.status(200).json({ message: \"Booking sent successfully\" });\r\n-    } catch (error) {\r\n-        console.error(\"Error sending booking email:\", error);\r\n-        return res.status(500).json({ message: \"Failed to send booking\" });\r\n-    }\r\n+    // üì© Confirmation email to applicant\r\n+    const confirmationMail = {\r\n+      from: `\"WashLabs\" <${process.env.EMAIL_USER}>`,\r\n+      to: userInfo.email,\r\n+      subject: `üßΩ Booking Confirmation - ${service.title}`,\r\n+      html: `\r\n+        <div style=\"font-family:Arial, sans-serif; line-height:1.6; color:#333;\">\r\n+          <h2 style=\"color:#22c55e;\">Thank you for your booking, ${\r\n+            userInfo.name\r\n+          }! üéâ</h2>\r\n+          <p>We‚Äôve received your request and our team will contact you if any additional details are needed.</p>\r\n+\r\n+          <h3 style=\"color:#f97316;\">Booking Summary</h3>\r\n+          <p><strong>Service:</strong> ${service.title} ${\r\n+        service.price ? `- $${service.price}` : \"\"\r\n+      }</p>\r\n+          <p><strong>Vehicle:</strong> ${vehicle.year} ${vehicle.name}</p>\r\n+          <p><strong>Date & Time:</strong> ${\r\n+            dateTime.date || \"N/A\"\r\n+          } at ${dateTime.time || \"N/A\"}</p>\r\n+\r\n+          ${\r\n+            userInfo.message\r\n+              ? `<p><strong>Your Notes:</strong><br/>${userInfo.message}</p>`\r\n+              : \"\"\r\n+          }\r\n+\r\n+          <hr/>\r\n+          <p style=\"font-size:0.9rem; color:gray;\">\r\n+            WashLabs Team<br/>\r\n+            üìç Halifax / Dartmouth / Bedford<br/>\r\n+            ‚úâÔ∏è washlabs.ca@gmail.com\r\n+          </p>\r\n+        </div>\r\n+      `,\r\n+    };\r\n+\r\n+    await transporter.sendMail(confirmationMail);\r\n+\r\n+    return res.status(200).json({ message: \"Booking and confirmation sent successfully\" });\r\n+  } catch (error) {\r\n+    console.error(\"Error sending booking email:\", error);\r\n+    return res.status(500).json({ message: \"Failed to send booking\" });\r\n+  }\r\n }\r\n"
                },
                {
                    "date": 1758176622129,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,96 @@\n+import nodemailer from \"nodemailer\";\r\n+\r\n+export default async function handler(req, res) {\r\n+  if (req.method !== \"POST\") {\r\n+    return res.status(405).json({ message: \"Method not allowed\" });\r\n+  }\r\n+\r\n+  const { service, vehicle, dateTime, userInfo } = req.body;\r\n+\r\n+  if (!service || !vehicle || !dateTime || !userInfo) {\r\n+    return res.status(400).json({ message: \"Missing booking details\" });\r\n+  }\r\n+\r\n+  try {\r\n+    const transporter = nodemailer.createTransport({\r\n+      service: \"gmail\",\r\n+      auth: {\r\n+        user: process.env.EMAIL_USER,\r\n+        pass: process.env.EMAIL_PASS,\r\n+      },\r\n+    });\r\n+\r\n+    // üì© Admin notification email\r\n+    const adminMail = {\r\n+      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n+      to: \"washlabs.ca@gmail.com\",\r\n+      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n+      html: `\r\n+        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n+        \r\n+        <h3 style=\"color:#f97316;\">Service</h3>\r\n+        <p><strong>${service.title}</strong></p>\r\n+        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n+        <p>${vehicle.year} ${vehicle.name}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n+        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n+\r\n+        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n+        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n+        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n+        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${userInfo.phone}</p>\r\n+        ${\r\n+          userInfo.message\r\n+            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n+            : \"\"\r\n+        }\r\n+\r\n+        <hr />\r\n+        <p style=\"font-size:0.9rem;color:gray;\">\r\n+          This booking was submitted from the WashLabs website booking form.\r\n+        </p>\r\n+      `,\r\n+      replyTo: userInfo.email, // ‚úÖ lets you reply directly to client\r\n+    };\r\n+\r\n+    await transporter.sendMail(adminMail);\r\n+\r\n+    // üì© Confirmation email to applicant (No Reply)\r\n+    const confirmationMail = {\r\n+      from: `\"WashLabs (No Reply)\" <no-reply@washlabs.ca>`, // ‚úÖ noreply\r\n+      to: userInfo.email,\r\n+      subject: `üßΩ Booking Confirmation - ${service.title}`,\r\n+      html: `\r\n+        <div style=\"font-family:Arial, sans-serif; line-height:1.6; color:#333;\">\r\n+          <h2 style=\"color:#22c55e;\">Thank you for your booking, ${userInfo.name}! üéâ</h2>\r\n+          <p>We‚Äôve received your request and our team will contact you if any additional details are needed.</p>\r\n+\r\n+          <h3 style=\"color:#f97316;\">Booking Summary</h3>\r\n+          <p><strong>Service:</strong> ${service.title} ${service.price ? `- $${service.price}` : \"\"}</p>\r\n+          <p><strong>Vehicle:</strong> ${vehicle.year} ${vehicle.name}</p>\r\n+          <p><strong>Date & Time:</strong> ${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n+\r\n+          ${userInfo.message ? `<p><strong>Your Notes:</strong><br/>${userInfo.message}</p>` : \"\"}\r\n+\r\n+          <hr/>\r\n+          <p style=\"font-size:0.9rem; color:gray;\">\r\n+            WashLabs Team<br/>\r\n+            üìç Halifax / Dartmouth / Bedford<br/>\r\n+            ‚úâÔ∏è washlabs.ca@gmail.com<br/>\r\n+            ‚ö†Ô∏è This is an automated message from a no-reply address. Please do not reply directly.\r\n+          </p>\r\n+        </div>\r\n+      `,\r\n+    };\r\n+\r\n+    await transporter.sendMail(confirmationMail);\r\n+\r\n+    return res.status(200).json({ message: \"Booking and confirmation sent successfully\" });\r\n+  } catch (error) {\r\n+    console.error(\"Error sending booking email:\", error);\r\n+    return res.status(500).json({ message: \"Failed to send booking\" });\r\n+  }\r\n+}\r\n"
                },
                {
                    "date": 1760159023696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,267 +1,347 @@\n import nodemailer from \"nodemailer\";\r\n \r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"POST\") {\r\n-    return res.status(405).json({ message: \"Method not allowed\" });\r\n-  }\r\n+const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n+const RATE_LIMIT_MAX_REQUESTS = 5;\r\n+const bookingRequestLog = new Map();\r\n \r\n-  const { service, vehicle, dateTime, userInfo } = req.body;\r\n+const getClientIdentifier = (req) => {\r\n+    const forwarded = req.headers[\"x-forwarded-for\"];\r\n+    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n+        return forwarded.split(\",\")[0].trim();\r\n+    }\r\n+    return req.socket?.remoteAddress || \"unknown\";\r\n+};\r\n \r\n-  if (!service || !vehicle || !dateTime || !userInfo) {\r\n-    return res.status(400).json({ message: \"Missing booking details\" });\r\n-  }\r\n+const isRateLimited = (identifier) => {\r\n+    const now = Date.now();\r\n+    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n+    const timestamps = bookingRequestLog.get(identifier) || [];\r\n+    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n \r\n-  try {\r\n-    const transporter = nodemailer.createTransport({\r\n-      service: \"gmail\",\r\n-      auth: {\r\n-        user: process.env.EMAIL_USER,\r\n-        pass: process.env.EMAIL_PASS,\r\n-      },\r\n-    });\r\n+    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n+        bookingRequestLog.set(identifier, recent);\r\n+        return true;\r\n+    }\r\n \r\n-    // üì© Admin notification email\r\n-    const adminMail = {\r\n-      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n-      to: \"washlabs.ca@gmail.com\",\r\n-      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n-      html: `\r\n-        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n-        \r\n-        <h3 style=\"color:#f97316;\">Service</h3>\r\n-        <p><strong>${service.title}</strong></p>\r\n-        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n+    recent.push(now);\r\n+    bookingRequestLog.set(identifier, recent);\r\n+    return false;\r\n+};\r\n \r\n-        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n-        <p>${vehicle.year} ${vehicle.name}</p>\r\n+// Basic HTML escape for safe email content\r\n+const escapeHtml = (str = \"\") =>\r\n+    String(str)\r\n+        .replace(/&/g, \"&amp;\")\r\n+        .replace(/</g, \"&lt;\")\r\n+        .replace(/>/g, \"&gt;\")\r\n+        .replace(/\"/g, \"&quot;\")\r\n+        .replace(/'/g, \"&#039;\");\r\n \r\n-        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n-        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n \r\n-        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n-        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n-        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n-        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${userInfo.phone}</p>\r\n-        ${\r\n-          userInfo.message\r\n-            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n-            : \"\"\r\n-        }\r\n+    const clientId = getClientIdentifier(req);\r\n+    if (isRateLimited(clientId)) {\r\n+        return res\r\n+            .status(429)\r\n+            .json({ message: \"Too many booking requests. Please try again soon.\" });\r\n+    }\r\n \r\n-        <hr />\r\n-        <p style=\"font-size:0.9rem;color:gray;\">\r\n-          This booking was submitted from the WashLabs website booking form.\r\n-        </p>\r\n-      `,\r\n-      replyTo: userInfo.email, // ‚úÖ lets you reply directly to client\r\n-    };\r\n+    const { service, vehicle, dateTime, userInfo } = req.body;\r\n \r\n-    await transporter.sendMail(adminMail);\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n \r\n-    // üì© Confirmation email to applicant (No Reply)\r\n-    const confirmationMail = {\r\n-      from: `\"WashLabs (No Reply)\" <no-reply@washlabs.ca>`, // ‚úÖ noreply\r\n-      to: userInfo.email,\r\n-      subject: `üßΩ Booking Confirmation - ${service.title}`,\r\n-      html: `\r\n-        <div style=\"font-family:Arial, sans-serif; line-height:1.6; color:#333;\">\r\n-          <h2 style=\"color:#22c55e;\">Thank you for your booking, ${userInfo.name}! üéâ</h2>\r\n-          <p>We‚Äôve received your request and our team will contact you if any additional details are needed.</p>\r\n+    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n+    if (!EMAIL_USER || !EMAIL_PASS) {\r\n+        console.error(\"[booking] Missing email credentials\", {\r\n+            hasUser: Boolean(EMAIL_USER),\r\n+            hasPass: Boolean(EMAIL_PASS),\r\n+        });\r\n+        return res.status(500).json({\r\n+            message:\r\n+                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n+        });\r\n+    }\r\n \r\n-          <h3 style=\"color:#f97316;\">Booking Summary</h3>\r\n-          <p><strong>Service:</strong> ${service.title} ${service.price ? `- $${service.price}` : \"\"}</p>\r\n-          <p><strong>Vehicle:</strong> ${vehicle.year} ${vehicle.name}</p>\r\n-          <p><strong>Date & Time:</strong> ${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n-\r\n-          ${userInfo.message ? `<p><strong>Your Notes:</strong><br/>${userInfo.message}</p>` : \"\"}\r\n-\r\n-          <hr/>\r\n-          <p style=\"font-size:0.9rem; color:gray;\">\r\n-            WashLabs Team<br/>\r\n-            üìç Halifax / Dartmouth / Bedford<br/>\r\n-            ‚úâÔ∏è washlabs.ca@gmail.com<br/>\r\n-            ‚ö†Ô∏è This is an automated message from a no-reply address. Please do not reply directly.\r\n-          </p>\r\n-        </div>\r\n-      `,\r\n+    // Sanitize inputs and compute meta\r\n+    const safeService = {\r\n+        title: escapeHtml(service.title || \"\"),\r\n     };\r\n+    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n+    const safeVehicleYear =\r\n+        vehicle?.year && vehicle.year !== \"NA\" ? escapeHtml(String(vehicle.year)) : \"\";\r\n+    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName].filter(Boolean).join(\" \");\r\n+    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n+    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeName = escapeHtml(userInfo?.name || \"\");\r\n+    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n+    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(userInfo?.phone || \"\")}`.trim();\r\n+    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n \r\n-    await transporter.sendMail(confirmationMail);\r\n+    const totalPrice =\r\n+        typeof service.totalPrice === \"number\"\r\n+            ? service.totalPrice\r\n+            : typeof service.basePrice === \"number\"\r\n+            ? service.basePrice\r\n+            : null;\r\n+    const formattedTotalPrice =\r\n+        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n \r\n-    return res.status(200).json({ message: \"Booking and confirmation sent successfully\" });\r\n-  } catch (error) {\r\n-    console.error(\"Error sending booking email:\", error);\r\n-    return res.status(500).json({ message: \"Failed to send booking\" });\r\n-  }\r\n-}\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"POST\") {\r\n-    return res.status(405).json({ message: \"Method not allowed\" });\r\n-  }\r\n-\r\n-  const { service, vehicle, dateTime, userInfo } = req.body;\r\n-\r\n-  if (!service || !vehicle || !dateTime || !userInfo) {\r\n-    return res.status(400).json({ message: \"Missing booking details\" });\r\n-  }\r\n-\r\n-  try {\r\n-    const transporter = nodemailer.createTransport({\r\n-      service: \"gmail\",\r\n-      auth: {\r\n-        user: process.env.EMAIL_USER,\r\n-        pass: process.env.EMAIL_PASS,\r\n-      },\r\n+    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n+        timeZone: \"America/Halifax\",\r\n+        hour12: false,\r\n     });\r\n+    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n+    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n \r\n-    // üì© Admin notification email\r\n-    const mailOptions = {\r\n-      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n-      to: \"washlabs.ca@gmail.com\",\r\n-      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n-      html: `\r\n-        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n-        \r\n-        <h3 style=\"color:#f97316;\">Service</h3>\r\n-        <p><strong>${service.title}</strong></p>\r\n-        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n-\r\n-        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n-        <p>${vehicle.year} ${vehicle.name}</p>\r\n-\r\n-        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n-        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n-\r\n-        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n-        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n-        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n-        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${\r\n-        userInfo.phone\r\n-      }</p>\r\n-        ${\r\n-          userInfo.message\r\n-            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n-            : \"\"\r\n-        }\r\n-\r\n-        <hr />\r\n-        <p style=\"font-size:0.9rem;color:gray;\">\r\n-          This booking was submitted from the WashLabs website booking form.\r\n-        </p>\r\n-      `,\r\n+    const baseUrl = \"https://washlabs.ca\";\r\n+    const brand = {\r\n+        name: \"Wash Labs\",\r\n+        color: \"#0076ff\",\r\n+        logo: `${baseUrl}/images/logo.png`,\r\n+        instagram: \"https://www.instagram.com/wash_labs\",\r\n+        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n+        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n+        email: \"washlabs.ca@gmail.com\",\r\n+        phone: \"+1 782-827-5010\",\r\n+        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n+        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n+        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n     };\r\n \r\n-    await transporter.sendMail(mailOptions);\r\n+    try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: EMAIL_USER,\r\n+                pass: EMAIL_PASS,\r\n+            },\r\n+        });\r\n \r\n-    // üì© Confirmation email to applicant\r\n-    const confirmationMail = {\r\n-      from: `\"WashLabs\" <${process.env.EMAIL_USER}>`,\r\n-      to: userInfo.email,\r\n-      subject: `üßΩ Booking Confirmation - ${service.title}`,\r\n-      html: `\r\n-        <div style=\"font-family:Arial, sans-serif; line-height:1.6; color:#333;\">\r\n-          <h2 style=\"color:#22c55e;\">Thank you for your booking, ${\r\n-            userInfo.name\r\n-          }! üéâ</h2>\r\n-          <p>We‚Äôve received your request and our team will contact you if any additional details are needed.</p>\r\n+        // Admin notification (branded + detailed)\r\n+        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n+        const adminText = `New booking request\r\n \r\n-          <h3 style=\"color:#f97316;\">Booking Summary</h3>\r\n-          <p><strong>Service:</strong> ${service.title} ${\r\n-        service.price ? `- $${service.price}` : \"\"\r\n-      }</p>\r\n-          <p><strong>Vehicle:</strong> ${vehicle.year} ${vehicle.name}</p>\r\n-          <p><strong>Date & Time:</strong> ${\r\n-            dateTime.date || \"N/A\"\r\n-          } at ${dateTime.time || \"N/A\"}</p>\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n \r\n-          ${\r\n-            userInfo.message\r\n-              ? `<p><strong>Your Notes:</strong><br/>${userInfo.message}</p>`\r\n-              : \"\"\r\n-          }\r\n+Client:\r\n+Name: ${userInfo.name}\r\n+Email: ${userInfo.email}\r\n+Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n+${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n+---\r\n+Received: ${receivedAt}\r\n+Client IP: ${clientId}\r\n+User-Agent: ${userAgent}\r\n+Referrer: ${referer}\r\n+`;\r\n \r\n-          <hr/>\r\n-          <p style=\"font-size:0.9rem; color:gray;\">\r\n-            WashLabs Team<br/>\r\n-            üìç Halifax / Dartmouth / Bedford<br/>\r\n-            ‚úâÔ∏è washlabs.ca@gmail.com\r\n-          </p>\r\n-        </div>\r\n-      `,\r\n-    };\r\n+        const adminHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:${brand.color};color:#fff;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n+                      <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                    </td>\r\n+                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${brand.hours}</td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px 24px 8px 24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n+                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:8px 24px 0 24px;\">\r\n+                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n+                ${\r\n+                    safeNotes\r\n+                        ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>`\r\n+                        : \"\"\r\n+                }\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>${brand.name}</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">${brand.address}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Areas: ${brand.areas}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n \r\n-    await transporter.sendMail(confirmationMail);\r\n+        const adminMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: brand.email,\r\n+            subject: adminSubject,\r\n+            text: adminText,\r\n+            html: adminHtml,\r\n+            replyTo: userInfo.email,\r\n+        };\r\n \r\n-    return res.status(200).json({ message: \"Booking and confirmation sent successfully\" });\r\n-  } catch (error) {\r\n-    console.error(\"Error sending booking email:\", error);\r\n-    return res.status(500).json({ message: \"Failed to send booking\" });\r\n-  }\r\n-}\r\n-import nodemailer from \"nodemailer\";\r\n+        await transporter.sendMail(adminMail);\r\n \r\n-export default async function handler(req, res) {\r\n-  if (req.method !== \"POST\") {\r\n-    return res.status(405).json({ message: \"Method not allowed\" });\r\n-  }\r\n+        // Customer confirmation (branded + logo, professional tone)\r\n+        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n+        const userText = `Hello ${userInfo.name},\r\n \r\n-  const { service, vehicle, dateTime, userInfo } = req.body;\r\n+Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n \r\n-  if (!service || !vehicle || !dateTime || !userInfo) {\r\n-    return res.status(400).json({ message: \"Missing booking details\" });\r\n-  }\r\n+Booking Summary\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n \r\n-  try {\r\n-    const transporter = nodemailer.createTransport({\r\n-      service: \"gmail\",\r\n-      auth: {\r\n-        user: process.env.EMAIL_USER,\r\n-        pass: process.env.EMAIL_PASS,\r\n-      },\r\n-    });\r\n+Need anything else?\r\n+Phone: ${brand.phone}\r\n+Email: ${brand.email}\r\n+Website: ${baseUrl}\r\n \r\n-    // Compose the booking email\r\n-    const mailOptions = {\r\n-      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n-      to: \"washlabs.ca@gmail.com\",\r\n-      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n-      html: `\r\n-        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n-        \r\n-        <h3 style=\"color:#f97316;\">Service</h3>\r\n-        <p><strong>${service.title}</strong></p>\r\n-        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n+‚Äî Wash Labs, Halifax NS`;\r\n \r\n-        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n-        <p>${vehicle.year} ${vehicle.name}</p>\r\n+        const userHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:${brand.color};color:#fff;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n+                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#fff;\">\r\n+                        <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                      </a>\r\n+                    </td>\r\n+                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${brand.hours}</td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n+                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n+                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+                ${\r\n+                    safeNotes\r\n+                        ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>`\r\n+                        : \"\"\r\n+                }\r\n+                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:0 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n \r\n-        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n-        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n+        const confirmationMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: userInfo.email,\r\n+            subject: userSubject,\r\n+            text: userText,\r\n+            html: userHtml,\r\n+            replyTo: brand.email, // allow replies to your main inbox\r\n+        };\r\n \r\n-        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n-        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n-        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n-        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${userInfo.phone}</p>\r\n-        ${\r\n-          userInfo.message\r\n-            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n-            : \"\"\r\n-        }\r\n+        await transporter.sendMail(confirmationMail);\r\n \r\n-        <hr />\r\n-        <p style=\"font-size:0.9rem;color:gray;\">\r\n-          This booking was submitted from the WashLabs website booking form.\r\n-        </p>\r\n-      `,\r\n-    };\r\n-\r\n-    await transporter.sendMail(mailOptions);\r\n-\r\n-    return res.status(200).json({ message: \"Booking sent successfully\" });\r\n-  } catch (error) {\r\n-    console.error(\"Error sending booking email:\", error);\r\n-    return res.status(500).json({ message: \"Failed to send booking\" });\r\n-  }\r\n+        return res\r\n+            .status(200)\r\n+            .json({ message: \"Booking and confirmation sent successfully\" });\r\n+    } catch (error) {\r\n+        console.error(\"[booking] Error sending booking email\", {\r\n+            error: error instanceof Error ? error.message : error,\r\n+            service: service?.title,\r\n+            client: clientId,\r\n+        });\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n }\r\n"
                },
                {
                    "date": 1760159328917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,409 @@\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n+const RATE_LIMIT_MAX_REQUESTS = 5;\r\n+const bookingRequestLog = new Map();\r\n+\r\n+const getClientIdentifier = (req) => {\r\n+    const forwarded = req.headers[\"x-forwarded-for\"];\r\n+    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n+        return forwarded.split(\",\")[0].trim();\r\n+    }\r\n+    return req.socket?.remoteAddress || \"unknown\";\r\n+};\r\n+\r\n+const isRateLimited = (identifier) => {\r\n+    const now = Date.now();\r\n+    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n+    const timestamps = bookingRequestLog.get(identifier) || [];\r\n+    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n+\r\n+    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n+        bookingRequestLog.set(identifier, recent);\r\n+        return true;\r\n+    }\r\n+\r\n+    recent.push(now);\r\n+    bookingRequestLog.set(identifier, recent);\r\n+    return false;\r\n+};\r\n+\r\n+// Basic HTML escape for safe email content\r\n+const escapeHtml = (str = \"\") =>\r\n+    String(str)\r\n+        .replace(/&/g, \"&amp;\")\r\n+        .replace(/</g, \"&lt;\")\r\n+        .replace(/>/g, \"&gt;\")\r\n+        .replace(/\"/g, \"&quot;\")\r\n+        .replace(/'/g, \"&#039;\");\r\n+\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const clientId = getClientIdentifier(req);\r\n+    if (isRateLimited(clientId)) {\r\n+        return res\r\n+            .status(429)\r\n+            .json({\r\n+                message: \"Too many booking requests. Please try again soon.\",\r\n+            });\r\n+    }\r\n+\r\n+    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n+\r\n+    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n+    if (!EMAIL_USER || !EMAIL_PASS) {\r\n+        console.error(\"[booking] Missing email credentials\", {\r\n+            hasUser: Boolean(EMAIL_USER),\r\n+            hasPass: Boolean(EMAIL_PASS),\r\n+        });\r\n+        return res.status(500).json({\r\n+            message:\r\n+                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n+        });\r\n+    }\r\n+\r\n+    // Sanitize inputs and compute meta\r\n+    const safeService = {\r\n+        title: escapeHtml(service.title || \"\"),\r\n+    };\r\n+    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n+    const safeVehicleYear =\r\n+        vehicle?.year && vehicle.year !== \"NA\"\r\n+            ? escapeHtml(String(vehicle.year))\r\n+            : \"\";\r\n+    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n+        .filter(Boolean)\r\n+        .join(\" \");\r\n+    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n+    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeName = escapeHtml(userInfo?.name || \"\");\r\n+    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n+    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n+        userInfo?.phone || \"\"\r\n+    )}`.trim();\r\n+    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n+\r\n+    const totalPrice =\r\n+        typeof service.totalPrice === \"number\"\r\n+            ? service.totalPrice\r\n+            : typeof service.basePrice === \"number\"\r\n+            ? service.basePrice\r\n+            : null;\r\n+    const formattedTotalPrice =\r\n+        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n+\r\n+    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n+        timeZone: \"America/Halifax\",\r\n+        hour12: false,\r\n+    });\r\n+    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n+    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n+\r\n+    const baseUrl = \"https://washlabs.ca\";\r\n+    const brand = {\r\n+        name: \"Wash Labs\",\r\n+        color: \"#0076ff\",\r\n+        logo: `${baseUrl}/images/logo.png`,\r\n+        instagram: \"https://www.instagram.com/wash_labs\",\r\n+        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n+        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n+        email: \"washlabs.ca@gmail.com\",\r\n+        phone: \"+1 782-827-5010\",\r\n+        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n+        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n+        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n+    };\r\n+\r\n+    try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: EMAIL_USER,\r\n+                pass: EMAIL_PASS,\r\n+            },\r\n+        });\r\n+\r\n+        // Admin notification (branded + detailed)\r\n+        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n+        const adminText = `New booking request\r\n+\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Client:\r\n+Name: ${userInfo.name}\r\n+Email: ${userInfo.email}\r\n+Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n+${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n+---\r\n+Received: ${receivedAt}\r\n+Client IP: ${clientId}\r\n+User-Agent: ${userAgent}\r\n+Referrer: ${referer}\r\n+`;\r\n+\r\n+        const adminHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:${\r\n+                  brand.color\r\n+              };color:#fff;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n+                      <img src=\"${brand.logo}\" alt=\"${\r\n+            brand.name\r\n+        }\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                    </td>\r\n+                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${\r\n+                        brand.hours\r\n+                    }</td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px 24px 8px 24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n+                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:8px 24px 0 24px;\">\r\n+                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${\r\n+                      safeService.title\r\n+                  }</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(\r\n+                      formattedTotalPrice\r\n+                  )}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">${safeEmail}</a></p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(\r\n+                    safePhone\r\n+                )}</p>\r\n+                ${\r\n+                    safeNotes\r\n+                        ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>`\r\n+                        : \"\"\r\n+                }\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(\r\n+                    clientId\r\n+                )}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(\r\n+                    userAgent\r\n+                )}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(\r\n+                    referer\r\n+                )}</p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>${\r\n+                          brand.name\r\n+                      }</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">${\r\n+                          brand.address\r\n+                      }</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Areas: ${\r\n+                          brand.areas\r\n+                      }</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">üìû ${\r\n+                          brand.phone\r\n+                      } ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const adminMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: brand.email,\r\n+            subject: adminSubject,\r\n+            text: adminText,\r\n+            html: adminHtml,\r\n+            replyTo: userInfo.email,\r\n+        };\r\n+\r\n+        await transporter.sendMail(adminMail);\r\n+\r\n+        // Customer confirmation (branded + logo, professional tone)\r\n+        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n+        const userText = `Hello ${userInfo.name},\r\n+\r\n+Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n+\r\n+Booking Summary\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Need anything else?\r\n+Phone: ${brand.phone}\r\n+Email: ${brand.email}\r\n+Website: ${baseUrl}\r\n+\r\n+‚Äî Wash Labs, Halifax NS`;\r\n+\r\n+        const userHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:${\r\n+                  brand.color\r\n+              };color:#fff;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n+                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#fff;\">\r\n+                        <img src=\"${brand.logo}\" alt=\"${\r\n+            brand.name\r\n+        }\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                      </a>\r\n+                    </td>\r\n+                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${\r\n+                        brand.hours\r\n+                    }</td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n+                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n+                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${\r\n+                      safeService.title\r\n+                  }</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(\r\n+                      formattedTotalPrice\r\n+                  )}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+                ${\r\n+                    safeNotes\r\n+                        ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>`\r\n+                        : \"\"\r\n+                }\r\n+                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:0 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${\r\n+                          brand.phone\r\n+                      } ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">washlabs.ca/#services</a></p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${\r\n+            brand.color\r\n+        };text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const confirmationMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: userInfo.email,\r\n+            subject: userSubject,\r\n+            text: userText,\r\n+            html: userHtml,\r\n+            replyTo: brand.email, // allow replies to your main inbox\r\n+        };\r\n+\r\n+        await transporter.sendMail(confirmationMail);\r\n+\r\n+        return res\r\n+            .status(200)\r\n+            .json({ message: \"Booking and confirmation sent successfully\" });\r\n+    } catch (error) {\r\n+        console.error(\"[booking] Error sending booking email\", {\r\n+            error: error instanceof Error ? error.message : error,\r\n+            service: service?.title,\r\n+            client: clientId,\r\n+        });\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1760159863704,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,338 @@\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n+const RATE_LIMIT_MAX_REQUESTS = 5;\r\n+const bookingRequestLog = new Map();\r\n+\r\n+const getClientIdentifier = (req) => {\r\n+    const forwarded = req.headers[\"x-forwarded-for\"];\r\n+    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n+        return forwarded.split(\",\")[0].trim();\r\n+    }\r\n+    return req.socket?.remoteAddress || \"unknown\";\r\n+};\r\n+\r\n+const isRateLimited = (identifier) => {\r\n+    const now = Date.now();\r\n+    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n+    const timestamps = bookingRequestLog.get(identifier) || [];\r\n+    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n+\r\n+    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n+        bookingRequestLog.set(identifier, recent);\r\n+        return true;\r\n+    }\r\n+\r\n+    recent.push(now);\r\n+    bookingRequestLog.set(identifier, recent);\r\n+    return false;\r\n+};\r\n+\r\n+// Basic HTML escape for safe email content\r\n+const escapeHtml = (str = \"\") =>\r\n+    String(str)\r\n+        .replace(/&/g, \"&amp;\")\r\n+        .replace(/</g, \"&lt;\")\r\n+        .replace(/>/g, \"&gt;\")\r\n+        .replace(/\"/g, \"&quot;\")\r\n+        .replace(/'/g, \"&#039;\");\r\n+\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const clientId = getClientIdentifier(req);\r\n+    if (isRateLimited(clientId)) {\r\n+        return res\r\n+            .status(429)\r\n+            .json({\r\n+                message: \"Too many booking requests. Please try again soon.\",\r\n+            });\r\n+    }\r\n+\r\n+    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n+\r\n+    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n+    if (!EMAIL_USER || !EMAIL_PASS) {\r\n+        console.error(\"[booking] Missing email credentials\", {\r\n+            hasUser: Boolean(EMAIL_USER),\r\n+            hasPass: Boolean(EMAIL_PASS),\r\n+        });\r\n+        return res.status(500).json({\r\n+            message:\r\n+                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n+        });\r\n+    }\r\n+\r\n+    // Sanitize inputs and compute meta\r\n+    const safeService = {\r\n+        title: escapeHtml(service.title || \"\"),\r\n+    };\r\n+    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n+    const safeVehicleYear =\r\n+        vehicle?.year && vehicle.year !== \"NA\"\r\n+            ? escapeHtml(String(vehicle.year))\r\n+            : \"\";\r\n+    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n+        .filter(Boolean)\r\n+        .join(\" \");\r\n+    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n+    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeName = escapeHtml(userInfo?.name || \"\");\r\n+    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n+    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n+        userInfo?.phone || \"\"\r\n+    )}`.trim();\r\n+    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n+\r\n+    const totalPrice =\r\n+        typeof service.totalPrice === \"number\"\r\n+            ? service.totalPrice\r\n+            : typeof service.basePrice === \"number\"\r\n+            ? service.basePrice\r\n+            : null;\r\n+    const formattedTotalPrice =\r\n+        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n+\r\n+    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n+        timeZone: \"America/Halifax\",\r\n+        hour12: false,\r\n+    });\r\n+    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n+    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n+\r\n+    const baseUrl = \"https://washlabs.ca\";\r\n+    const brand = {\r\n+        name: \"Wash Labs\",\r\n+        color: \"#0076ff\",\r\n+        logo: `${baseUrl}/images/logo.png`,\r\n+        instagram: \"https://www.instagram.com/wash_labs\",\r\n+        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n+        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n+        email: \"washlabs.ca@gmail.com\",\r\n+        phone: \"+1 782-827-5010\",\r\n+        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n+        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n+        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n+    };\r\n+\r\n+    try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: EMAIL_USER,\r\n+                pass: EMAIL_PASS,\r\n+            },\r\n+        });\r\n+\r\n+        // Admin notification (branded + detailed)\r\n+        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n+        const adminText = `New booking request\r\n+\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Client:\r\n+Name: ${userInfo.name}\r\n+Email: ${userInfo.email}\r\n+Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n+${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n+---\r\n+Received: ${receivedAt}\r\n+Client IP: ${clientId}\r\n+User-Agent: ${userAgent}\r\n+Referrer: ${referer}\r\n+`;\r\n+\r\n+        const adminHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <div style=\"display:inline-flex;align-items:center;gap:10px;\">\r\n+                        <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                        <div style=\"font-size:20px;font-weight:800;letter-spacing:0.5px;\">\r\n+                          <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                        </div>\r\n+                      </div>\r\n+                      <div style=\"font-size:13px;color:#334155;margin-top:6px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px 24px 8px 24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n+                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:8px 24px 0 24px;\">\r\n+                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n+                ${safeNotes ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 24px 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const adminMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: brand.email,\r\n+            subject: adminSubject,\r\n+            text: adminText,\r\n+            html: adminHtml,\r\n+            replyTo: userInfo.email,\r\n+        };\r\n+\r\n+        await transporter.sendMail(adminMail);\r\n+\r\n+        // Customer confirmation (branded + logo, professional tone)\r\n+        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n+        const userText = `Hello ${userInfo.name},\r\n+\r\n+Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n+\r\n+Booking Summary\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Need anything else?\r\n+Phone: ${brand.phone}\r\n+Email: ${brand.email}\r\n+Website: ${baseUrl}\r\n+\r\n+‚Äî Wash Labs, Halifax NS`;\r\n+\r\n+        const userHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:20px 24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#0f172a;\">\r\n+                        <div style=\"display:inline-flex;align-items:center;gap:10px;\">\r\n+                          <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n+                          <div style=\"font-size:20px;font-weight:800;letter-spacing:0.5px;\">\r\n+                            <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                          </div>\r\n+                        </div>\r\n+                      </a>\r\n+                      <div style=\"font-size:13px;color:#334155;margin-top:6px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n+                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n+                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+                ${safeNotes ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:0 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const confirmationMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: userInfo.email,\r\n+            subject: userSubject,\r\n+            text: userText,\r\n+            html: userHtml,\r\n+            replyTo: brand.email, // allow replies to your main inbox\r\n+        };\r\n+\r\n+        await transporter.sendMail(confirmationMail);\r\n+\r\n+        return res\r\n+            .status(200)\r\n+            .json({ message: \"Booking and confirmation sent successfully\" });\r\n+    } catch (error) {\r\n+        console.error(\"[booking] Error sending booking email\", {\r\n+            error: error instanceof Error ? error.message : error,\r\n+            service: service?.title,\r\n+            client: clientId,\r\n+        });\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1760160123654,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,350 @@\n+import nodemailer from \"nodemailer\";\r\n+\r\n+const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n+const RATE_LIMIT_MAX_REQUESTS = 5;\r\n+const bookingRequestLog = new Map();\r\n+\r\n+const getClientIdentifier = (req) => {\r\n+    const forwarded = req.headers[\"x-forwarded-for\"];\r\n+    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n+        return forwarded.split(\",\")[0].trim();\r\n+    }\r\n+    return req.socket?.remoteAddress || \"unknown\";\r\n+};\r\n+\r\n+const isRateLimited = (identifier) => {\r\n+    const now = Date.now();\r\n+    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n+    const timestamps = bookingRequestLog.get(identifier) || [];\r\n+    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n+\r\n+    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n+        bookingRequestLog.set(identifier, recent);\r\n+        return true;\r\n+    }\r\n+\r\n+    recent.push(now);\r\n+    bookingRequestLog.set(identifier, recent);\r\n+    return false;\r\n+};\r\n+\r\n+// Basic HTML escape for safe email content\r\n+const escapeHtml = (str = \"\") =>\r\n+    String(str)\r\n+        .replace(/&/g, \"&amp;\")\r\n+        .replace(/</g, \"&lt;\")\r\n+        .replace(/>/g, \"&gt;\")\r\n+        .replace(/\"/g, \"&quot;\")\r\n+        .replace(/'/g, \"&#039;\");\r\n+\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const clientId = getClientIdentifier(req);\r\n+    if (isRateLimited(clientId)) {\r\n+        return res\r\n+            .status(429)\r\n+            .json({\r\n+                message: \"Too many booking requests. Please try again soon.\",\r\n+            });\r\n+    }\r\n+\r\n+    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n+\r\n+    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n+    if (!EMAIL_USER || !EMAIL_PASS) {\r\n+        console.error(\"[booking] Missing email credentials\", {\r\n+            hasUser: Boolean(EMAIL_USER),\r\n+            hasPass: Boolean(EMAIL_PASS),\r\n+        });\r\n+        return res.status(500).json({\r\n+            message:\r\n+                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n+        });\r\n+    }\r\n+\r\n+    // Sanitize inputs and compute meta\r\n+    const safeService = {\r\n+        title: escapeHtml(service.title || \"\"),\r\n+    };\r\n+    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n+    const safeVehicleYear =\r\n+        vehicle?.year && vehicle.year !== \"NA\"\r\n+            ? escapeHtml(String(vehicle.year))\r\n+            : \"\";\r\n+    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n+        .filter(Boolean)\r\n+        .join(\" \");\r\n+    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n+    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeName = escapeHtml(userInfo?.name || \"\");\r\n+    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n+    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n+        userInfo?.phone || \"\"\r\n+    )}`.trim();\r\n+    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n+\r\n+    const totalPrice =\r\n+        typeof service.totalPrice === \"number\"\r\n+            ? service.totalPrice\r\n+            : typeof service.basePrice === \"number\"\r\n+            ? service.basePrice\r\n+            : null;\r\n+    const formattedTotalPrice =\r\n+        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n+\r\n+    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n+        timeZone: \"America/Halifax\",\r\n+        hour12: false,\r\n+    });\r\n+    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n+    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n+\r\n+    const baseUrl = \"https://washlabs.ca\";\r\n+    const brand = {\r\n+        name: \"Wash Labs\",\r\n+        color: \"#0076ff\",\r\n+        logo: `${baseUrl}/images/logo.png`,\r\n+        instagram: \"https://www.instagram.com/wash_labs\",\r\n+        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n+        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n+        email: \"washlabs.ca@gmail.com\",\r\n+        phone: \"+1 782-827-5010\",\r\n+        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n+        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n+        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n+    };\r\n+\r\n+    try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: EMAIL_USER,\r\n+                pass: EMAIL_PASS,\r\n+            },\r\n+        });\r\n+\r\n+        // Admin notification (branded + detailed)\r\n+        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n+        const adminText = `New booking request\r\n+\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Client:\r\n+Name: ${userInfo.name}\r\n+Email: ${userInfo.email}\r\n+Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n+${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n+---\r\n+Received: ${receivedAt}\r\n+Client IP: ${clientId}\r\n+User-Agent: ${userAgent}\r\n+Referrer: ${referer}\r\n+`;\r\n+\r\n+        const adminHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" align=\"center\">\r\n+                        <tr>\r\n+                          <td align=\"center\" valign=\"middle\" style=\"padding-right:10px;\">\r\n+                            <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"52\" style=\"display:block;border:0;\"/>\r\n+                          </td>\r\n+                          <td align=\"center\" valign=\"middle\" style=\"padding-left:10px;\">\r\n+                            <div style=\"font-size:26px;line-height:1;font-weight:900;letter-spacing:0.6px;white-space:nowrap;\">\r\n+                              <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                            </div>\r\n+                          </td>\r\n+                        </tr>\r\n+                      </table>\r\n+                      <div style=\"text-align:center;font-size:14px;color:#334155;margin-top:8px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px 24px 8px 24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n+                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:8px 24px 0 24px;\">\r\n+                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n+                ${safeNotes ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 24px 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const adminMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: brand.email,\r\n+            subject: adminSubject,\r\n+            text: adminText,\r\n+            html: adminHtml,\r\n+            replyTo: userInfo.email,\r\n+        };\r\n+\r\n+        await transporter.sendMail(adminMail);\r\n+\r\n+        // Customer confirmation (branded + logo, professional tone)\r\n+        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n+        const userText = `Hello ${userInfo.name},\r\n+\r\n+Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n+\r\n+Booking Summary\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+\r\n+Need anything else?\r\n+Phone: ${brand.phone}\r\n+Email: ${brand.email}\r\n+Website: ${baseUrl}\r\n+\r\n+‚Äî Wash Labs, Halifax NS`;\r\n+\r\n+        const userHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#0f172a;\">\r\n+                        <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" align=\"center\">\r\n+                          <tr>\r\n+                            <td align=\"center\" valign=\"middle\" style=\"padding-right:10px;\">\r\n+                              <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"52\" style=\"display:block;border:0;\"/>\r\n+                            </td>\r\n+                            <td align=\"center\" valign=\"middle\" style=\"padding-left:10px;\">\r\n+                              <div style=\"font-size:26px;line-height:1;font-weight:900;letter-spacing:0.6px;white-space:nowrap;\">\r\n+                                <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                              </div>\r\n+                            </td>\r\n+                          </tr>\r\n+                        </table>\r\n+                      </a>\r\n+                      <div style=\"text-align:center;font-size:14px;color:#334155;margin-top:8px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n+                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n+                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                </table>\r\n+                ${safeNotes ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:0 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const confirmationMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: userInfo.email,\r\n+            subject: userSubject,\r\n+            text: userText,\r\n+            html: userHtml,\r\n+            replyTo: brand.email, // allow replies to your main inbox\r\n+        };\r\n+\r\n+        await transporter.sendMail(confirmationMail);\r\n+\r\n+        return res\r\n+            .status(200)\r\n+            .json({ message: \"Booking and confirmation sent successfully\" });\r\n+    } catch (error) {\r\n+        console.error(\"[booking] Error sending booking email\", {\r\n+            error: error instanceof Error ? error.message : error,\r\n+            service: service?.title,\r\n+            client: clientId,\r\n+        });\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1760621096022,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,9 +50,9 @@\n                 message: \"Too many booking requests. Please try again soon.\",\r\n             });\r\n     }\r\n \r\n-    const { service, vehicle, dateTime, userInfo } = req.body;\r\n+    const { service, vehicle, dateTime, location, userInfo } = req.body;\r\n \r\n     if (!service || !vehicle || !dateTime || !userInfo) {\r\n         return res.status(400).json({ message: \"Missing booking details\" });\r\n     }\r\n@@ -82,8 +82,9 @@\n         .filter(Boolean)\r\n         .join(\" \");\r\n     const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n     const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeLocation = escapeHtml(location?.address || \"Not specified\");\r\n     const safeName = escapeHtml(userInfo?.name || \"\");\r\n     const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n     const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n         userInfo?.phone || \"\"\r\n@@ -137,8 +138,9 @@\n Service: ${service.title}\r\n Total Price: ${formattedTotalPrice}\r\n Vehicle: ${vehicleDisplay}\r\n Date & Time: ${safeDate} at ${safeTime}\r\n+Location: ${location?.address || \"Not specified\"}\r\n \r\n Client:\r\n Name: ${userInfo.name}\r\n Email: ${userInfo.email}\r\n@@ -194,8 +196,9 @@\n                   <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n                   <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n                   <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n                   <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Location:</strong> ${safeLocation}</td></tr>\r\n                 </table>\r\n               </td>\r\n             </tr>\r\n             <tr>\r\n@@ -236,15 +239,16 @@\n         // Customer confirmation (branded + logo, professional tone)\r\n         const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n         const userText = `Hello ${userInfo.name},\r\n \r\n-Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n+Thanks for booking with Wash Labs. We've received your request and will follow up shortly.\r\n \r\n Booking Summary\r\n Service: ${service.title}\r\n Total Price: ${formattedTotalPrice}\r\n Vehicle: ${vehicleDisplay}\r\n Date & Time: ${safeDate} at ${safeTime}\r\n+Location: ${location?.address || \"Not specified\"}\r\n \r\n Need anything else?\r\n Phone: ${brand.phone}\r\n Email: ${brand.email}\r\n@@ -294,8 +298,9 @@\n                   <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n                   <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n                   <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n                   <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Location:</strong> ${safeLocation}</td></tr>\r\n                 </table>\r\n                 ${safeNotes ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n                 <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n               </td>\r\n@@ -347,1098 +352,4 @@\n         });\r\n         return res.status(500).json({ message: \"Failed to send booking\" });\r\n     }\r\n }\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n-const RATE_LIMIT_MAX_REQUESTS = 5;\r\n-const bookingRequestLog = new Map();\r\n-\r\n-const getClientIdentifier = (req) => {\r\n-    const forwarded = req.headers[\"x-forwarded-for\"];\r\n-    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n-        return forwarded.split(\",\")[0].trim();\r\n-    }\r\n-    return req.socket?.remoteAddress || \"unknown\";\r\n-};\r\n-\r\n-const isRateLimited = (identifier) => {\r\n-    const now = Date.now();\r\n-    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n-    const timestamps = bookingRequestLog.get(identifier) || [];\r\n-    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n-\r\n-    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n-        bookingRequestLog.set(identifier, recent);\r\n-        return true;\r\n-    }\r\n-\r\n-    recent.push(now);\r\n-    bookingRequestLog.set(identifier, recent);\r\n-    return false;\r\n-};\r\n-\r\n-// Basic HTML escape for safe email content\r\n-const escapeHtml = (str = \"\") =>\r\n-    String(str)\r\n-        .replace(/&/g, \"&amp;\")\r\n-        .replace(/</g, \"&lt;\")\r\n-        .replace(/>/g, \"&gt;\")\r\n-        .replace(/\"/g, \"&quot;\")\r\n-        .replace(/'/g, \"&#039;\");\r\n-\r\n-export default async function handler(req, res) {\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ message: \"Method not allowed\" });\r\n-    }\r\n-\r\n-    const clientId = getClientIdentifier(req);\r\n-    if (isRateLimited(clientId)) {\r\n-        return res\r\n-            .status(429)\r\n-            .json({\r\n-                message: \"Too many booking requests. Please try again soon.\",\r\n-            });\r\n-    }\r\n-\r\n-    const { service, vehicle, dateTime, userInfo } = req.body;\r\n-\r\n-    if (!service || !vehicle || !dateTime || !userInfo) {\r\n-        return res.status(400).json({ message: \"Missing booking details\" });\r\n-    }\r\n-\r\n-    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n-    if (!EMAIL_USER || !EMAIL_PASS) {\r\n-        console.error(\"[booking] Missing email credentials\", {\r\n-            hasUser: Boolean(EMAIL_USER),\r\n-            hasPass: Boolean(EMAIL_PASS),\r\n-        });\r\n-        return res.status(500).json({\r\n-            message:\r\n-                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n-        });\r\n-    }\r\n-\r\n-    // Sanitize inputs and compute meta\r\n-    const safeService = {\r\n-        title: escapeHtml(service.title || \"\"),\r\n-    };\r\n-    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n-    const safeVehicleYear =\r\n-        vehicle?.year && vehicle.year !== \"NA\"\r\n-            ? escapeHtml(String(vehicle.year))\r\n-            : \"\";\r\n-    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n-        .filter(Boolean)\r\n-        .join(\" \");\r\n-    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n-    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n-    const safeName = escapeHtml(userInfo?.name || \"\");\r\n-    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n-    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n-        userInfo?.phone || \"\"\r\n-    )}`.trim();\r\n-    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n-\r\n-    const totalPrice =\r\n-        typeof service.totalPrice === \"number\"\r\n-            ? service.totalPrice\r\n-            : typeof service.basePrice === \"number\"\r\n-            ? service.basePrice\r\n-            : null;\r\n-    const formattedTotalPrice =\r\n-        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n-\r\n-    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n-        timeZone: \"America/Halifax\",\r\n-        hour12: false,\r\n-    });\r\n-    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n-    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n-\r\n-    const baseUrl = \"https://washlabs.ca\";\r\n-    const brand = {\r\n-        name: \"Wash Labs\",\r\n-        color: \"#0076ff\",\r\n-        logo: `${baseUrl}/images/logo.png`,\r\n-        instagram: \"https://www.instagram.com/wash_labs\",\r\n-        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n-        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n-        email: \"washlabs.ca@gmail.com\",\r\n-        phone: \"+1 782-827-5010\",\r\n-        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n-        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n-        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n-    };\r\n-\r\n-    try {\r\n-        const transporter = nodemailer.createTransport({\r\n-            service: \"gmail\",\r\n-            auth: {\r\n-                user: EMAIL_USER,\r\n-                pass: EMAIL_PASS,\r\n-            },\r\n-        });\r\n-\r\n-        // Admin notification (branded + detailed)\r\n-        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n-        const adminText = `New booking request\r\n-\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Client:\r\n-Name: ${userInfo.name}\r\n-Email: ${userInfo.email}\r\n-Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n-${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n----\r\n-Received: ${receivedAt}\r\n-Client IP: ${clientId}\r\n-User-Agent: ${userAgent}\r\n-Referrer: ${referer}\r\n-`;\r\n-\r\n-        const adminHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:#eff6ff;color:#0f172a;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n-                      <div style=\"display:inline-flex;align-items:center;gap:10px;\">\r\n-                        <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                        <div style=\"font-size:20px;font-weight:800;letter-spacing:0.5px;\">\r\n-                          <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n-                        </div>\r\n-                      </div>\r\n-                      <div style=\"font-size:13px;color:#334155;margin-top:6px;\">${brand.hours}</div>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px 24px 8px 24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n-                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:8px 24px 0 24px;\">\r\n-                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 0 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n-                ${safeNotes ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 24px 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const adminMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: brand.email,\r\n-            subject: adminSubject,\r\n-            text: adminText,\r\n-            html: adminHtml,\r\n-            replyTo: userInfo.email,\r\n-        };\r\n-\r\n-        await transporter.sendMail(adminMail);\r\n-\r\n-        // Customer confirmation (branded + logo, professional tone)\r\n-        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n-        const userText = `Hello ${userInfo.name},\r\n-\r\n-Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n-\r\n-Booking Summary\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Need anything else?\r\n-Phone: ${brand.phone}\r\n-Email: ${brand.email}\r\n-Website: ${baseUrl}\r\n-\r\n-‚Äî Wash Labs, Halifax NS`;\r\n-\r\n-        const userHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:#eff6ff;color:#0f172a;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n-                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#0f172a;\">\r\n-                        <div style=\"display:inline-flex;align-items:center;gap:10px;\">\r\n-                          <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                          <div style=\"font-size:20px;font-weight:800;letter-spacing:0.5px;\">\r\n-                            <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n-                          </div>\r\n-                        </div>\r\n-                      </a>\r\n-                      <div style=\"font-size:13px;color:#334155;margin-top:6px;\">${brand.hours}</div>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n-                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n-                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-                ${safeNotes ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n-                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:0 24px 24px 24px;\">\r\n-                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n-                  <tr>\r\n-                    <td style=\"padding:14px 16px;\">\r\n-                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n-                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n-                      <p style=\"margin:8px 0 0 0;\">\r\n-                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n-                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n-                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n-                      </p>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const confirmationMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: userInfo.email,\r\n-            subject: userSubject,\r\n-            text: userText,\r\n-            html: userHtml,\r\n-            replyTo: brand.email, // allow replies to your main inbox\r\n-        };\r\n-\r\n-        await transporter.sendMail(confirmationMail);\r\n-\r\n-        return res\r\n-            .status(200)\r\n-            .json({ message: \"Booking and confirmation sent successfully\" });\r\n-    } catch (error) {\r\n-        console.error(\"[booking] Error sending booking email\", {\r\n-            error: error instanceof Error ? error.message : error,\r\n-            service: service?.title,\r\n-            client: clientId,\r\n-        });\r\n-        return res.status(500).json({ message: \"Failed to send booking\" });\r\n-    }\r\n-}\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n-const RATE_LIMIT_MAX_REQUESTS = 5;\r\n-const bookingRequestLog = new Map();\r\n-\r\n-const getClientIdentifier = (req) => {\r\n-    const forwarded = req.headers[\"x-forwarded-for\"];\r\n-    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n-        return forwarded.split(\",\")[0].trim();\r\n-    }\r\n-    return req.socket?.remoteAddress || \"unknown\";\r\n-};\r\n-\r\n-const isRateLimited = (identifier) => {\r\n-    const now = Date.now();\r\n-    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n-    const timestamps = bookingRequestLog.get(identifier) || [];\r\n-    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n-\r\n-    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n-        bookingRequestLog.set(identifier, recent);\r\n-        return true;\r\n-    }\r\n-\r\n-    recent.push(now);\r\n-    bookingRequestLog.set(identifier, recent);\r\n-    return false;\r\n-};\r\n-\r\n-// Basic HTML escape for safe email content\r\n-const escapeHtml = (str = \"\") =>\r\n-    String(str)\r\n-        .replace(/&/g, \"&amp;\")\r\n-        .replace(/</g, \"&lt;\")\r\n-        .replace(/>/g, \"&gt;\")\r\n-        .replace(/\"/g, \"&quot;\")\r\n-        .replace(/'/g, \"&#039;\");\r\n-\r\n-export default async function handler(req, res) {\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ message: \"Method not allowed\" });\r\n-    }\r\n-\r\n-    const clientId = getClientIdentifier(req);\r\n-    if (isRateLimited(clientId)) {\r\n-        return res\r\n-            .status(429)\r\n-            .json({\r\n-                message: \"Too many booking requests. Please try again soon.\",\r\n-            });\r\n-    }\r\n-\r\n-    const { service, vehicle, dateTime, userInfo } = req.body;\r\n-\r\n-    if (!service || !vehicle || !dateTime || !userInfo) {\r\n-        return res.status(400).json({ message: \"Missing booking details\" });\r\n-    }\r\n-\r\n-    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n-    if (!EMAIL_USER || !EMAIL_PASS) {\r\n-        console.error(\"[booking] Missing email credentials\", {\r\n-            hasUser: Boolean(EMAIL_USER),\r\n-            hasPass: Boolean(EMAIL_PASS),\r\n-        });\r\n-        return res.status(500).json({\r\n-            message:\r\n-                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n-        });\r\n-    }\r\n-\r\n-    // Sanitize inputs and compute meta\r\n-    const safeService = {\r\n-        title: escapeHtml(service.title || \"\"),\r\n-    };\r\n-    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n-    const safeVehicleYear =\r\n-        vehicle?.year && vehicle.year !== \"NA\"\r\n-            ? escapeHtml(String(vehicle.year))\r\n-            : \"\";\r\n-    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n-        .filter(Boolean)\r\n-        .join(\" \");\r\n-    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n-    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n-    const safeName = escapeHtml(userInfo?.name || \"\");\r\n-    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n-    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n-        userInfo?.phone || \"\"\r\n-    )}`.trim();\r\n-    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n-\r\n-    const totalPrice =\r\n-        typeof service.totalPrice === \"number\"\r\n-            ? service.totalPrice\r\n-            : typeof service.basePrice === \"number\"\r\n-            ? service.basePrice\r\n-            : null;\r\n-    const formattedTotalPrice =\r\n-        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n-\r\n-    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n-        timeZone: \"America/Halifax\",\r\n-        hour12: false,\r\n-    });\r\n-    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n-    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n-\r\n-    const baseUrl = \"https://washlabs.ca\";\r\n-    const brand = {\r\n-        name: \"Wash Labs\",\r\n-        color: \"#0076ff\",\r\n-        logo: `${baseUrl}/images/logo.png`,\r\n-        instagram: \"https://www.instagram.com/wash_labs\",\r\n-        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n-        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n-        email: \"washlabs.ca@gmail.com\",\r\n-        phone: \"+1 782-827-5010\",\r\n-        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n-        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n-        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n-    };\r\n-\r\n-    try {\r\n-        const transporter = nodemailer.createTransport({\r\n-            service: \"gmail\",\r\n-            auth: {\r\n-                user: EMAIL_USER,\r\n-                pass: EMAIL_PASS,\r\n-            },\r\n-        });\r\n-\r\n-        // Admin notification (branded + detailed)\r\n-        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n-        const adminText = `New booking request\r\n-\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Client:\r\n-Name: ${userInfo.name}\r\n-Email: ${userInfo.email}\r\n-Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n-${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n----\r\n-Received: ${receivedAt}\r\n-Client IP: ${clientId}\r\n-User-Agent: ${userAgent}\r\n-Referrer: ${referer}\r\n-`;\r\n-\r\n-        const adminHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:${\r\n-                  brand.color\r\n-              };color:#fff;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n-                      <img src=\"${brand.logo}\" alt=\"${\r\n-            brand.name\r\n-        }\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                    </td>\r\n-                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${\r\n-                        brand.hours\r\n-                    }</td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px 24px 8px 24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n-                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:8px 24px 0 24px;\">\r\n-                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${\r\n-                      safeService.title\r\n-                  }</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(\r\n-                      formattedTotalPrice\r\n-                  )}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 0 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">${safeEmail}</a></p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(\r\n-                    safePhone\r\n-                )}</p>\r\n-                ${\r\n-                    safeNotes\r\n-                        ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>`\r\n-                        : \"\"\r\n-                }\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 0 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(\r\n-                    clientId\r\n-                )}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(\r\n-                    userAgent\r\n-                )}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(\r\n-                    referer\r\n-                )}</p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px 24px 24px;\">\r\n-                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n-                  <tr>\r\n-                    <td style=\"padding:14px 16px;\">\r\n-                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>${\r\n-                          brand.name\r\n-                      }</strong></p>\r\n-                      <p style=\"margin:0;color:#334155;font-size:13px;\">${\r\n-                          brand.address\r\n-                      }</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Areas: ${\r\n-                          brand.areas\r\n-                      }</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">üìû ${\r\n-                          brand.phone\r\n-                      } ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n-                      <p style=\"margin:8px 0 0 0;\">\r\n-                        <a href=\"${brand.instagram}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">Instagram</a> ¬∑\r\n-                        <a href=\"${brand.facebook}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">Facebook</a> ¬∑\r\n-                        <a href=\"${brand.tiktok}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">TikTok</a>\r\n-                      </p>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const adminMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: brand.email,\r\n-            subject: adminSubject,\r\n-            text: adminText,\r\n-            html: adminHtml,\r\n-            replyTo: userInfo.email,\r\n-        };\r\n-\r\n-        await transporter.sendMail(adminMail);\r\n-\r\n-        // Customer confirmation (branded + logo, professional tone)\r\n-        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n-        const userText = `Hello ${userInfo.name},\r\n-\r\n-Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n-\r\n-Booking Summary\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Need anything else?\r\n-Phone: ${brand.phone}\r\n-Email: ${brand.email}\r\n-Website: ${baseUrl}\r\n-\r\n-‚Äî Wash Labs, Halifax NS`;\r\n-\r\n-        const userHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:${\r\n-                  brand.color\r\n-              };color:#fff;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n-                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#fff;\">\r\n-                        <img src=\"${brand.logo}\" alt=\"${\r\n-            brand.name\r\n-        }\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                      </a>\r\n-                    </td>\r\n-                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${\r\n-                        brand.hours\r\n-                    }</td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n-                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n-                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${\r\n-                      safeService.title\r\n-                  }</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(\r\n-                      formattedTotalPrice\r\n-                  )}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-                ${\r\n-                    safeNotes\r\n-                        ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>`\r\n-                        : \"\"\r\n-                }\r\n-                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:0 24px 24px 24px;\">\r\n-                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n-                  <tr>\r\n-                    <td style=\"padding:14px 16px;\">\r\n-                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n-                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${\r\n-                          brand.phone\r\n-                      } ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">washlabs.ca/#services</a></p>\r\n-                      <p style=\"margin:8px 0 0 0;\">\r\n-                        <a href=\"${brand.instagram}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">Instagram</a> ¬∑\r\n-                        <a href=\"${brand.facebook}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">Facebook</a> ¬∑\r\n-                        <a href=\"${brand.tiktok}\" style=\"color:${\r\n-            brand.color\r\n-        };text-decoration:none;\">TikTok</a>\r\n-                      </p>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const confirmationMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: userInfo.email,\r\n-            subject: userSubject,\r\n-            text: userText,\r\n-            html: userHtml,\r\n-            replyTo: brand.email, // allow replies to your main inbox\r\n-        };\r\n-\r\n-        await transporter.sendMail(confirmationMail);\r\n-\r\n-        return res\r\n-            .status(200)\r\n-            .json({ message: \"Booking and confirmation sent successfully\" });\r\n-    } catch (error) {\r\n-        console.error(\"[booking] Error sending booking email\", {\r\n-            error: error instanceof Error ? error.message : error,\r\n-            service: service?.title,\r\n-            client: clientId,\r\n-        });\r\n-        return res.status(500).json({ message: \"Failed to send booking\" });\r\n-    }\r\n-}\r\n-import nodemailer from \"nodemailer\";\r\n-\r\n-const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n-const RATE_LIMIT_MAX_REQUESTS = 5;\r\n-const bookingRequestLog = new Map();\r\n-\r\n-const getClientIdentifier = (req) => {\r\n-    const forwarded = req.headers[\"x-forwarded-for\"];\r\n-    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n-        return forwarded.split(\",\")[0].trim();\r\n-    }\r\n-    return req.socket?.remoteAddress || \"unknown\";\r\n-};\r\n-\r\n-const isRateLimited = (identifier) => {\r\n-    const now = Date.now();\r\n-    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n-    const timestamps = bookingRequestLog.get(identifier) || [];\r\n-    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n-\r\n-    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n-        bookingRequestLog.set(identifier, recent);\r\n-        return true;\r\n-    }\r\n-\r\n-    recent.push(now);\r\n-    bookingRequestLog.set(identifier, recent);\r\n-    return false;\r\n-};\r\n-\r\n-// Basic HTML escape for safe email content\r\n-const escapeHtml = (str = \"\") =>\r\n-    String(str)\r\n-        .replace(/&/g, \"&amp;\")\r\n-        .replace(/</g, \"&lt;\")\r\n-        .replace(/>/g, \"&gt;\")\r\n-        .replace(/\"/g, \"&quot;\")\r\n-        .replace(/'/g, \"&#039;\");\r\n-\r\n-export default async function handler(req, res) {\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ message: \"Method not allowed\" });\r\n-    }\r\n-\r\n-    const clientId = getClientIdentifier(req);\r\n-    if (isRateLimited(clientId)) {\r\n-        return res\r\n-            .status(429)\r\n-            .json({ message: \"Too many booking requests. Please try again soon.\" });\r\n-    }\r\n-\r\n-    const { service, vehicle, dateTime, userInfo } = req.body;\r\n-\r\n-    if (!service || !vehicle || !dateTime || !userInfo) {\r\n-        return res.status(400).json({ message: \"Missing booking details\" });\r\n-    }\r\n-\r\n-    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n-    if (!EMAIL_USER || !EMAIL_PASS) {\r\n-        console.error(\"[booking] Missing email credentials\", {\r\n-            hasUser: Boolean(EMAIL_USER),\r\n-            hasPass: Boolean(EMAIL_PASS),\r\n-        });\r\n-        return res.status(500).json({\r\n-            message:\r\n-                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n-        });\r\n-    }\r\n-\r\n-    // Sanitize inputs and compute meta\r\n-    const safeService = {\r\n-        title: escapeHtml(service.title || \"\"),\r\n-    };\r\n-    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n-    const safeVehicleYear =\r\n-        vehicle?.year && vehicle.year !== \"NA\" ? escapeHtml(String(vehicle.year)) : \"\";\r\n-    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName].filter(Boolean).join(\" \");\r\n-    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n-    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n-    const safeName = escapeHtml(userInfo?.name || \"\");\r\n-    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n-    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(userInfo?.phone || \"\")}`.trim();\r\n-    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n-\r\n-    const totalPrice =\r\n-        typeof service.totalPrice === \"number\"\r\n-            ? service.totalPrice\r\n-            : typeof service.basePrice === \"number\"\r\n-            ? service.basePrice\r\n-            : null;\r\n-    const formattedTotalPrice =\r\n-        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n-\r\n-    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n-        timeZone: \"America/Halifax\",\r\n-        hour12: false,\r\n-    });\r\n-    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n-    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n-\r\n-    const baseUrl = \"https://washlabs.ca\";\r\n-    const brand = {\r\n-        name: \"Wash Labs\",\r\n-        color: \"#0076ff\",\r\n-        logo: `${baseUrl}/images/logo.png`,\r\n-        instagram: \"https://www.instagram.com/wash_labs\",\r\n-        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n-        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n-        email: \"washlabs.ca@gmail.com\",\r\n-        phone: \"+1 782-827-5010\",\r\n-        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n-        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n-        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n-    };\r\n-\r\n-    try {\r\n-        const transporter = nodemailer.createTransport({\r\n-            service: \"gmail\",\r\n-            auth: {\r\n-                user: EMAIL_USER,\r\n-                pass: EMAIL_PASS,\r\n-            },\r\n-        });\r\n-\r\n-        // Admin notification (branded + detailed)\r\n-        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n-        const adminText = `New booking request\r\n-\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Client:\r\n-Name: ${userInfo.name}\r\n-Email: ${userInfo.email}\r\n-Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n-${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n----\r\n-Received: ${receivedAt}\r\n-Client IP: ${clientId}\r\n-User-Agent: ${userAgent}\r\n-Referrer: ${referer}\r\n-`;\r\n-\r\n-        const adminHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:${brand.color};color:#fff;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n-                      <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                    </td>\r\n-                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${brand.hours}</td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px 24px 8px 24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n-                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:8px 24px 0 24px;\">\r\n-                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 0 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n-                ${\r\n-                    safeNotes\r\n-                        ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>`\r\n-                        : \"\"\r\n-                }\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:16px 24px 0 24px;\">\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n-                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px 24px 24px;\">\r\n-                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n-                  <tr>\r\n-                    <td style=\"padding:14px 16px;\">\r\n-                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>${brand.name}</strong></p>\r\n-                      <p style=\"margin:0;color:#334155;font-size:13px;\">${brand.address}</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Areas: ${brand.areas}</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n-                      <p style=\"margin:8px 0 0 0;\">\r\n-                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n-                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n-                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n-                      </p>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const adminMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: brand.email,\r\n-            subject: adminSubject,\r\n-            text: adminText,\r\n-            html: adminHtml,\r\n-            replyTo: userInfo.email,\r\n-        };\r\n-\r\n-        await transporter.sendMail(adminMail);\r\n-\r\n-        // Customer confirmation (branded + logo, professional tone)\r\n-        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n-        const userText = `Hello ${userInfo.name},\r\n-\r\n-Thanks for booking with Wash Labs. We‚Äôve received your request and will follow up shortly.\r\n-\r\n-Booking Summary\r\n-Service: ${service.title}\r\n-Total Price: ${formattedTotalPrice}\r\n-Vehicle: ${vehicleDisplay}\r\n-Date & Time: ${safeDate} at ${safeTime}\r\n-\r\n-Need anything else?\r\n-Phone: ${brand.phone}\r\n-Email: ${brand.email}\r\n-Website: ${baseUrl}\r\n-\r\n-‚Äî Wash Labs, Halifax NS`;\r\n-\r\n-        const userHtml = `\r\n-<!doctype html>\r\n-<html>\r\n-  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n-    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n-      <tr>\r\n-        <td align=\"center\">\r\n-          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n-            <tr>\r\n-              <td style=\"padding:20px 24px;background:${brand.color};color:#fff;\">\r\n-                <table width=\"100%\">\r\n-                  <tr>\r\n-                    <td align=\"left\" style=\"vertical-align:middle;\">\r\n-                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#fff;\">\r\n-                        <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"40\" style=\"display:block;border:0;\"/>\r\n-                      </a>\r\n-                    </td>\r\n-                    <td align=\"right\" style=\"font-size:14px;opacity:0.9;\">${brand.hours}</td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:24px;\">\r\n-                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n-                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n-                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n-                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n-                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n-                </table>\r\n-                ${\r\n-                    safeNotes\r\n-                        ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>`\r\n-                        : \"\"\r\n-                }\r\n-                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n-              </td>\r\n-            </tr>\r\n-            <tr>\r\n-              <td style=\"padding:0 24px 24px 24px;\">\r\n-                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n-                  <tr>\r\n-                    <td style=\"padding:14px 16px;\">\r\n-                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n-                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n-                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n-                      <p style=\"margin:8px 0 0 0;\">\r\n-                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n-                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n-                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n-                      </p>\r\n-                    </td>\r\n-                  </tr>\r\n-                </table>\r\n-              </td>\r\n-            </tr>\r\n-          </table>\r\n-        </td>\r\n-      </tr>\r\n-    </table>\r\n-  </body>\r\n-</html>`;\r\n-\r\n-        const confirmationMail = {\r\n-            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n-            to: userInfo.email,\r\n-            subject: userSubject,\r\n-            text: userText,\r\n-            html: userHtml,\r\n-            replyTo: brand.email, // allow replies to your main inbox\r\n-        };\r\n-\r\n-        await transporter.sendMail(confirmationMail);\r\n-\r\n-        return res\r\n-            .status(200)\r\n-            .json({ message: \"Booking and confirmation sent successfully\" });\r\n-    } catch (error) {\r\n-        console.error(\"[booking] Error sending booking email\", {\r\n-            error: error instanceof Error ? error.message : error,\r\n-            service: service?.title,\r\n-            client: clientId,\r\n-        });\r\n-        return res.status(500).json({ message: \"Failed to send booking\" });\r\n-    }\r\n-}\r\n"
                },
                {
                    "date": 1760676297298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,6 @@\n import nodemailer from \"nodemailer\";\r\n+import { MongoClient } from \"mongodb\";\r\n \r\n const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n const RATE_LIMIT_MAX_REQUESTS = 5;\r\n const bookingRequestLog = new Map();\r\n@@ -121,9 +122,10 @@\n         hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n         address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n     };\r\n \r\n-    try {\r\n+  let client;\r\n+  try {\r\n         const transporter = nodemailer.createTransport({\r\n             service: \"gmail\",\r\n             auth: {\r\n                 user: EMAIL_USER,\r\n@@ -338,13 +340,50 @@\n             html: userHtml,\r\n             replyTo: brand.email, // allow replies to your main inbox\r\n         };\r\n \r\n-        await transporter.sendMail(confirmationMail);\r\n+    await transporter.sendMail(confirmationMail);\r\n \r\n-        return res\r\n-            .status(200)\r\n-            .json({ message: \"Booking and confirmation sent successfully\" });\r\n+    // Insert booking into MongoDB (best-effort, after emails)\r\n+    const uri = process.env.MONGODB_URI;\r\n+    const dbName = process.env.MONGODB_DB;\r\n+    let insertedId = null;\r\n+    if (uri && dbName) {\r\n+      try {\r\n+        client = await MongoClient.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });\r\n+        const db = client.db(dbName);\r\n+        const collection = db.collection(\"bookings\");\r\n+        const doc = {\r\n+          // Align with admin schema\r\n+          name: userInfo.name,\r\n+          carName: vehicleDisplay,\r\n+          service: service.title,\r\n+          date: dateTime.date,\r\n+          time: dateTime.time,\r\n+          amount: totalPrice ?? undefined,\r\n+          status: \"pending\",\r\n+          phone: userInfo.phone,\r\n+          email: userInfo.email,\r\n+          location: location?.address || \"\",\r\n+          addOns: Array.isArray(service?.addOns) ? service.addOns : [],\r\n+          carType: vehicle?.type || \"\",\r\n+          createdAt: new Date().toISOString(),\r\n+          source: \"online\",\r\n+        };\r\n+        const result = await collection.insertOne(doc);\r\n+        insertedId = result.insertedId;\r\n+      } catch (dbErr) {\r\n+        console.error(\"[booking] DB insert failed:\", dbErr?.message || dbErr);\r\n+      } finally {\r\n+        if (client) await client.close();\r\n+      }\r\n+    } else {\r\n+      console.warn(\"[booking] Skipping DB insert: missing MONGODB config\");\r\n+    }\r\n+\r\n+    return res\r\n+      .status(200)\r\n+      .json({ message: \"Booking and confirmation sent successfully\", insertedId });\r\n     } catch (error) {\r\n         console.error(\"[booking] Error sending booking email\", {\r\n             error: error instanceof Error ? error.message : error,\r\n             service: service?.title,\r\n"
                },
                {
                    "date": 1760729870744,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -348,9 +348,9 @@\n     const dbName = process.env.MONGODB_DB;\r\n     let insertedId = null;\r\n     if (uri && dbName) {\r\n       try {\r\n-        client = await MongoClient.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });\r\n+        client = await MongoClient.connect(uri);\r\n         const db = client.db(dbName);\r\n         const collection = db.collection(\"bookings\");\r\n         const doc = {\r\n           // Align with admin schema\r\n"
                },
                {
                    "date": 1760730387066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,392 @@\n+import nodemailer from \"nodemailer\";\r\n+import { MongoClient } from \"mongodb\";\r\n+import { getDb } from \"../../lib/mongodb\";\r\n+\r\n+const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n+const RATE_LIMIT_MAX_REQUESTS = 5;\r\n+const bookingRequestLog = new Map();\r\n+\r\n+const getClientIdentifier = (req) => {\r\n+    const forwarded = req.headers[\"x-forwarded-for\"];\r\n+    if (typeof forwarded === \"string\" && forwarded.length > 0) {\r\n+        return forwarded.split(\",\")[0].trim();\r\n+    }\r\n+    return req.socket?.remoteAddress || \"unknown\";\r\n+};\r\n+\r\n+const isRateLimited = (identifier) => {\r\n+    const now = Date.now();\r\n+    const windowStart = now - RATE_LIMIT_WINDOW_MS;\r\n+    const timestamps = bookingRequestLog.get(identifier) || [];\r\n+    const recent = timestamps.filter((timestamp) => timestamp > windowStart);\r\n+\r\n+    if (recent.length >= RATE_LIMIT_MAX_REQUESTS) {\r\n+        bookingRequestLog.set(identifier, recent);\r\n+        return true;\r\n+    }\r\n+\r\n+    recent.push(now);\r\n+    bookingRequestLog.set(identifier, recent);\r\n+    return false;\r\n+};\r\n+\r\n+// Basic HTML escape for safe email content\r\n+const escapeHtml = (str = \"\") =>\r\n+    String(str)\r\n+        .replace(/&/g, \"&amp;\")\r\n+        .replace(/</g, \"&lt;\")\r\n+        .replace(/>/g, \"&gt;\")\r\n+        .replace(/\"/g, \"&quot;\")\r\n+        .replace(/'/g, \"&#039;\");\r\n+\r\n+export default async function handler(req, res) {\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ message: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const clientId = getClientIdentifier(req);\r\n+    if (isRateLimited(clientId)) {\r\n+        return res\r\n+            .status(429)\r\n+            .json({\r\n+                message: \"Too many booking requests. Please try again soon.\",\r\n+            });\r\n+    }\r\n+\r\n+    const { service, vehicle, dateTime, location, userInfo } = req.body;\r\n+\r\n+    if (!service || !vehicle || !dateTime || !userInfo) {\r\n+        return res.status(400).json({ message: \"Missing booking details\" });\r\n+    }\r\n+\r\n+    const { EMAIL_USER, EMAIL_PASS } = process.env;\r\n+    if (!EMAIL_USER || !EMAIL_PASS) {\r\n+        console.error(\"[booking] Missing email credentials\", {\r\n+            hasUser: Boolean(EMAIL_USER),\r\n+            hasPass: Boolean(EMAIL_PASS),\r\n+        });\r\n+        return res.status(500).json({\r\n+            message:\r\n+                \"Our booking inbox is temporarily unavailable. Please contact us directly while we resolve this.\",\r\n+        });\r\n+    }\r\n+\r\n+    // Sanitize inputs and compute meta\r\n+    const safeService = {\r\n+        title: escapeHtml(service.title || \"\"),\r\n+    };\r\n+    const safeVehicleName = escapeHtml(vehicle?.name || \"\");\r\n+    const safeVehicleYear =\r\n+        vehicle?.year && vehicle.year !== \"NA\"\r\n+            ? escapeHtml(String(vehicle.year))\r\n+            : \"\";\r\n+    const vehicleDisplay = [safeVehicleYear || null, safeVehicleName]\r\n+        .filter(Boolean)\r\n+        .join(\" \");\r\n+    const safeDate = escapeHtml(dateTime?.date || \"N/A\");\r\n+    const safeTime = escapeHtml(dateTime?.time || \"N/A\");\r\n+    const safeLocation = escapeHtml(location?.address || \"Not specified\");\r\n+    const safeName = escapeHtml(userInfo?.name || \"\");\r\n+    const safeEmail = escapeHtml(userInfo?.email || \"\");\r\n+    const safePhone = `${escapeHtml(userInfo?.countryCode || \"\")} ${escapeHtml(\r\n+        userInfo?.phone || \"\"\r\n+    )}`.trim();\r\n+    const safeNotes = escapeHtml(userInfo?.message || \"\");\r\n+\r\n+    const totalPrice =\r\n+        typeof service.totalPrice === \"number\"\r\n+            ? service.totalPrice\r\n+            : typeof service.basePrice === \"number\"\r\n+            ? service.basePrice\r\n+            : null;\r\n+    const formattedTotalPrice =\r\n+        typeof totalPrice === \"number\" ? `$${totalPrice}` : \"Not specified\";\r\n+\r\n+    const receivedAt = new Date().toLocaleString(\"en-CA\", {\r\n+        timeZone: \"America/Halifax\",\r\n+        hour12: false,\r\n+    });\r\n+    const userAgent = (req.headers[\"user-agent\"] || \"\").slice(0, 300);\r\n+    const referer = req.headers[\"referer\"] || req.headers[\"referrer\"] || \"N/A\";\r\n+\r\n+    const baseUrl = \"https://washlabs.ca\";\r\n+    const brand = {\r\n+        name: \"Wash Labs\",\r\n+        color: \"#0076ff\",\r\n+        logo: `${baseUrl}/images/logo.png`,\r\n+        instagram: \"https://www.instagram.com/wash_labs\",\r\n+        facebook: \"https://www.facebook.com/people/Wash-Labs/61581335875166/\",\r\n+        tiktok: \"https://www.tiktok.com/@wash__labs\",\r\n+        email: \"washlabs.ca@gmail.com\",\r\n+        phone: \"+1 782-827-5010\",\r\n+        areas: \"Halifax ‚Ä¢ Dartmouth ‚Ä¢ Bedford ‚Ä¢ Sackville ‚Ä¢ Clayton Park ‚Ä¢ Cole Harbour ‚Ä¢ Hammonds Plains\",\r\n+        hours: \"7:00 AM ‚Äì 7:00 PM (Mon‚ÄìSun)\",\r\n+        address: \"53 Vitalia Ct, Halifax, NS B3S 0H4\",\r\n+    };\r\n+\r\n+  let client;\r\n+  try {\r\n+        const transporter = nodemailer.createTransport({\r\n+            service: \"gmail\",\r\n+            auth: {\r\n+                user: EMAIL_USER,\r\n+                pass: EMAIL_PASS,\r\n+            },\r\n+        });\r\n+\r\n+        // Admin notification (branded + detailed)\r\n+        const adminSubject = `New Booking Request ‚Äî ${safeService.title}`;\r\n+        const adminText = `New booking request\r\n+\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+Location: ${location?.address || \"Not specified\"}\r\n+\r\n+Client:\r\n+Name: ${userInfo.name}\r\n+Email: ${userInfo.email}\r\n+Phone: ${userInfo.countryCode || \"\"} ${userInfo.phone}\r\n+${userInfo.message ? `Notes:\\n${userInfo.message}\\n` : \"\"}\r\n+---\r\n+Received: ${receivedAt}\r\n+Client IP: ${clientId}\r\n+User-Agent: ${userAgent}\r\n+Referrer: ${referer}\r\n+`;\r\n+\r\n+        const adminHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" align=\"center\">\r\n+                        <tr>\r\n+                          <td align=\"center\" valign=\"middle\" style=\"padding-right:10px;\">\r\n+                            <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"52\" style=\"display:block;border:0;\"/>\r\n+                          </td>\r\n+                          <td align=\"center\" valign=\"middle\" style=\"padding-left:10px;\">\r\n+                            <div style=\"font-size:26px;line-height:1;font-weight:900;letter-spacing:0.6px;white-space:nowrap;\">\r\n+                              <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                            </div>\r\n+                          </td>\r\n+                        </tr>\r\n+                      </table>\r\n+                      <div style=\"text-align:center;font-size:14px;color:#334155;margin-top:8px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px 24px 8px 24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">New Booking Request</h1>\r\n+                <p style=\"margin:0;color:#334155;font-size:14px;\">Received: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:8px 24px 0 24px;\">\r\n+                <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                  <tr><td style=\"padding:6px 0;\"><strong>Location:</strong> ${safeLocation}</td></tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 0 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Client</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Name:</strong> ${safeName}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Email:</strong> <a href=\"mailto:${safeEmail}\" style=\"color:${brand.color};text-decoration:none;\">${safeEmail}</a></p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Phone:</strong> ${escapeHtml(safePhone)}</p>\r\n+                ${safeNotes ? `<div style=\"margin-top:8px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:16px 24px 24px 24px;\">\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Context</h2>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Client IP:</strong> ${escapeHtml(clientId)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>User-Agent:</strong> ${escapeHtml(userAgent)}</p>\r\n+                <p style=\"margin:0;color:#475569;font-size:13px;\"><strong>Referrer:</strong> ${escapeHtml(referer)}</p>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const adminMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: brand.email,\r\n+            subject: adminSubject,\r\n+            text: adminText,\r\n+            html: adminHtml,\r\n+            replyTo: userInfo.email,\r\n+        };\r\n+\r\n+        await transporter.sendMail(adminMail);\r\n+\r\n+        // Customer confirmation (branded + logo, professional tone)\r\n+        const userSubject = `Booking received ‚Äî ${safeService.title} | Wash Labs`;\r\n+        const userText = `Hello ${userInfo.name},\r\n+\r\n+Thanks for booking with Wash Labs. We've received your request and will follow up shortly.\r\n+\r\n+Booking Summary\r\n+Service: ${service.title}\r\n+Total Price: ${formattedTotalPrice}\r\n+Vehicle: ${vehicleDisplay}\r\n+Date & Time: ${safeDate} at ${safeTime}\r\n+Location: ${location?.address || \"Not specified\"}\r\n+\r\n+Need anything else?\r\n+Phone: ${brand.phone}\r\n+Email: ${brand.email}\r\n+Website: ${baseUrl}\r\n+\r\n+‚Äî Wash Labs, Halifax NS`;\r\n+\r\n+        const userHtml = `\r\n+<!doctype html>\r\n+<html>\r\n+  <body style=\"margin:0;padding:0;background:#f6f9fc;font-family:Inter,Arial,sans-serif;\">\r\n+    <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f6f9fc;padding:24px 0;\">\r\n+      <tr>\r\n+        <td align=\"center\">\r\n+          <table role=\"presentation\" width=\"640\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#ffffff;border:1px solid #e6effe;border-radius:12px;overflow:hidden;\">\r\n+            <tr>\r\n+              <td style=\"padding:24px;background:#eff6ff;color:#0f172a;\">\r\n+                <table width=\"100%\">\r\n+                  <tr>\r\n+                    <td align=\"center\" style=\"vertical-align:middle;\">\r\n+                      <a href=\"${baseUrl}\" style=\"text-decoration:none;color:#0f172a;\">\r\n+                        <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" align=\"center\">\r\n+                          <tr>\r\n+                            <td align=\"center\" valign=\"middle\" style=\"padding-right:10px;\">\r\n+                              <img src=\"${brand.logo}\" alt=\"${brand.name}\" height=\"52\" style=\"display:block;border:0;\"/>\r\n+                            </td>\r\n+                            <td align=\"center\" valign=\"middle\" style=\"padding-left:10px;\">\r\n+                              <div style=\"font-size:26px;line-height:1;font-weight:900;letter-spacing:0.6px;white-space:nowrap;\">\r\n+                                <span style=\"color:#000;\">WASH</span> <span style=\"color:${brand.color};\">LABS</span>\r\n+                              </div>\r\n+                            </td>\r\n+                          </tr>\r\n+                        </table>\r\n+                      </a>\r\n+                      <div style=\"text-align:center;font-size:14px;color:#334155;margin-top:8px;\">${brand.hours}</div>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:24px;\">\r\n+                <h1 style=\"margin:0 0 8px 0;font-size:20px;color:#0f172a;\">Thanks for your booking, ${safeName}!</h1>\r\n+                <p style=\"margin:0 0 14px 0;color:#334155;font-size:14px;\">We‚Äôve received your request and will follow up shortly.</p>\r\n+                <h2 style=\"margin:0 0 8px 0;font-size:16px;color:#0f172a;\">Booking Summary</h2>\r\n+                <table cellpadding=\"0\" cellspacing=\"0\" style=\"font-size:14px;color:#0f172a;\">\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Service:</strong> ${safeService.title}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Total Price:</strong> ${escapeHtml(formattedTotalPrice)}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Vehicle:</strong> ${vehicleDisplay}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Date &amp; Time:</strong> ${safeDate} at ${safeTime}</td></tr>\r\n+                  <tr><td style=\"padding:4px 0;\"><strong>Location:</strong> ${safeLocation}</td></tr>\r\n+                </table>\r\n+                ${safeNotes ? `<div style=\"margin-top:12px;padding:12px;border-left:3px solid ${brand.color};background:#f8fbff;color:#334155;white-space:pre-wrap;\"><strong>Your Notes:</strong>\\n${safeNotes}</div>` : \"\"}\r\n+                <p style=\"margin:16px 0 0 0;color:#475569;font-size:13px;\">Sent on: <strong>${receivedAt}</strong></p>\r\n+              </td>\r\n+            </tr>\r\n+            <tr>\r\n+              <td style=\"padding:0 24px 24px 24px;\">\r\n+                <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background:#f8fbff;border:1px solid #e6effe;border-radius:10px;\">\r\n+                  <tr>\r\n+                    <td style=\"padding:14px 16px;\">\r\n+                      <p style=\"margin:0 0 6px 0;color:#0f172a;font-size:14px;\"><strong>Need to reach us?</strong></p>\r\n+                      <p style=\"margin:0;color:#334155;font-size:13px;\">üìû ${brand.phone} ‚Ä¢ ‚úâÔ∏è ${brand.email}</p>\r\n+                      <p style=\"margin:6px 0 0 0;color:#334155;font-size:13px;\">Book another service: <a href=\"${baseUrl}/#services\" style=\"color:${brand.color};text-decoration:none;\">washlabs.ca/#services</a></p>\r\n+                      <p style=\"margin:8px 0 0 0;\">\r\n+                        <a href=\"${brand.instagram}\" style=\"color:${brand.color};text-decoration:none;\">Instagram</a> ¬∑\r\n+                        <a href=\"${brand.facebook}\" style=\"color:${brand.color};text-decoration:none;\">Facebook</a> ¬∑\r\n+                        <a href=\"${brand.tiktok}\" style=\"color:${brand.color};text-decoration:none;\">TikTok</a>\r\n+                      </p>\r\n+                    </td>\r\n+                  </tr>\r\n+                </table>\r\n+              </td>\r\n+            </tr>\r\n+          </table>\r\n+        </td>\r\n+      </tr>\r\n+    </table>\r\n+  </body>\r\n+</html>`;\r\n+\r\n+        const confirmationMail = {\r\n+            from: `\"Wash Labs\" <${EMAIL_USER}>`,\r\n+            to: userInfo.email,\r\n+            subject: userSubject,\r\n+            text: userText,\r\n+            html: userHtml,\r\n+            replyTo: brand.email, // allow replies to your main inbox\r\n+        };\r\n+\r\n+    await transporter.sendMail(confirmationMail);\r\n+\r\n+    // Insert booking into MongoDB (best-effort, after emails)\r\n+    const uri = process.env.MONGODB_URI;\r\n+    const dbName = process.env.MONGODB_DB;\r\n+    let insertedId = null;\r\n+    if (uri && dbName) {\r\n+      try {\r\n+        const db = await getDb();\r\n+        const collection = db.collection(\"bookings\");\r\n+        const doc = {\r\n+          // Align with admin schema\r\n+          name: userInfo.name,\r\n+          carName: vehicleDisplay,\r\n+          service: service.title,\r\n+          date: dateTime.date,\r\n+          time: dateTime.time,\r\n+          amount: totalPrice ?? undefined,\r\n+          status: \"pending\",\r\n+          phone: userInfo.phone,\r\n+          email: userInfo.email,\r\n+          location: location?.address || \"\",\r\n+          addOns: Array.isArray(service?.addOns) ? service.addOns : [],\r\n+          carType: vehicle?.type || \"\",\r\n+          createdAt: new Date().toISOString(),\r\n+          source: \"online\",\r\n+        };\r\n+        const result = await collection.insertOne(doc);\r\n+        insertedId = result.insertedId;\r\n+      } catch (dbErr) {\r\n+        console.error(\"[booking] DB insert failed:\", dbErr?.message || dbErr);\r\n+      }\r\n+    } else {\r\n+      console.warn(\"[booking] Skipping DB insert: missing MONGODB config\");\r\n+    }\r\n+\r\n+    return res\r\n+      .status(200)\r\n+      .json({ message: \"Booking and confirmation sent successfully\", insertedId });\r\n+    } catch (error) {\r\n+        console.error(\"[booking] Error sending booking email\", {\r\n+            error: error instanceof Error ? error.message : error,\r\n+            service: service?.title,\r\n+            client: clientId,\r\n+        });\r\n+        return res.status(500).json({ message: \"Failed to send booking\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1760730803057,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,6 @@\n import nodemailer from \"nodemailer\";\r\n import { MongoClient } from \"mongodb\";\r\n-import { getDb } from \"../../lib/mongodb\";\r\n \r\n const RATE_LIMIT_WINDOW_MS = 60 * 1000;\r\n const RATE_LIMIT_MAX_REQUESTS = 5;\r\n const bookingRequestLog = new Map();\r\n@@ -349,9 +348,10 @@\n     const dbName = process.env.MONGODB_DB;\r\n     let insertedId = null;\r\n     if (uri && dbName) {\r\n       try {\r\n-        const db = await getDb();\r\n+        client = await MongoClient.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });\r\n+        const db = client.db(dbName);\r\n         const collection = db.collection(\"bookings\");\r\n         const doc = {\r\n           // Align with admin schema\r\n           name: userInfo.name,\r\n@@ -372,8 +372,10 @@\n         const result = await collection.insertOne(doc);\r\n         insertedId = result.insertedId;\r\n       } catch (dbErr) {\r\n         console.error(\"[booking] DB insert failed:\", dbErr?.message || dbErr);\r\n+      } finally {\r\n+        if (client) await client.close();\r\n       }\r\n     } else {\r\n       console.warn(\"[booking] Skipping DB insert: missing MONGODB config\");\r\n     }\r\n"
                }
            ],
            "date": 1757955580780,
            "name": "Commit-0",
            "content": "import nodemailer from \"nodemailer\";\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== \"POST\") {\r\n    return res.status(405).json({ message: \"Method not allowed\" });\r\n  }\r\n\r\n  const { service, vehicle, dateTime, userInfo } = req.body;\r\n\r\n  if (!service || !vehicle || !dateTime || !userInfo) {\r\n    return res.status(400).json({ message: \"Missing booking details\" });\r\n  }\r\n\r\n  try {\r\n    const transporter = nodemailer.createTransport({\r\n      service: \"gmail\",\r\n      auth: {\r\n        user: process.env.EMAIL_USER,\r\n        pass: process.env.EMAIL_PASS,\r\n      },\r\n    });\r\n\r\n    // Compose the booking email\r\n    const mailOptions = {\r\n      from: `\"WashLabs Booking\" <${process.env.EMAIL_USER}>`,\r\n      to: \"washlabs.ca@gmail.com\",\r\n      subject: `‚úÖ New Booking Request - ${service.title}`,\r\n      html: `\r\n        <h2 style=\"color:#22c55e;\">New Booking Request</h2>\r\n        \r\n        <h3 style=\"color:#f97316;\">Service</h3>\r\n        <p><strong>${service.title}</strong></p>\r\n        <p>${service.price ? \"Price: $\" + service.price : \"\"}</p>\r\n\r\n        <h3 style=\"color:#f97316;\">Vehicle</h3>\r\n        <p>${vehicle.year} ${vehicle.name}</p>\r\n\r\n        <h3 style=\"color:#f97316;\">Date & Time</h3>\r\n        <p>${dateTime.date || \"N/A\"} at ${dateTime.time || \"N/A\"}</p>\r\n\r\n        <h3 style=\"color:#f97316;\">Client Information</h3>\r\n        <p><strong>Name:</strong> ${userInfo.name}</p>\r\n        <p><strong>Email:</strong> ${userInfo.email}</p>\r\n        <p><strong>Phone:</strong> ${userInfo.countryCode || \"\"} ${userInfo.phone}</p>\r\n        ${\r\n          userInfo.message\r\n            ? `<p><strong>Notes:</strong><br/>${userInfo.message}</p>`\r\n            : \"\"\r\n        }\r\n\r\n        <hr />\r\n        <p style=\"font-size:0.9rem;color:gray;\">\r\n          This booking was submitted from the WashLabs website booking form.\r\n        </p>\r\n      `,\r\n    };\r\n\r\n    await transporter.sendMail(mailOptions);\r\n\r\n    return res.status(200).json({ message: \"Booking sent successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Error sending booking email:\", error);\r\n    return res.status(500).json({ message: \"Failed to send booking\" });\r\n  }\r\n}\r\n"
        }
    ]
}